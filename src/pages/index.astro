---
import BaseLayout from '../layouts/BaseLayout.astro';
import { getT, onLangChange } from '../i18n/index.ts';
import ProjectCard from '../components/ProjectCard.astro';

const GITHUB_TOKEN = process.env.GITHUB_TOKEN;

async function getRepoMeta(repoUrl: string): Promise<{
  avatar?: string;
  stars?: number;
  name?: string;
  description?: string;
}> {
  try {
    const url = new URL(repoUrl);
    if (url.hostname !== 'github.com') return {};
    const segments = url.pathname.split('/').filter(Boolean);
    const owner = segments[0];
    const repo = (segments[1] || '').replace(/\.git$/, '');
    if (!owner || !repo) return {};
    const apiUrl = `https://api.github.com/repos/${owner}/${repo}`;
    const res = await fetch(apiUrl, {
      headers: {
        'User-Agent': 'astro-portfolio',
        ...(GITHUB_TOKEN ? { Authorization: `Bearer ${GITHUB_TOKEN}` } : {}),
        Accept: 'application/vnd.github+json',
      },
    });
    if (!res.ok) return {};
    const data = await res.json();
    return {
      avatar: data?.owner?.avatar_url,
      stars: data?.stargazers_count,
      name: data?.name,
      description: data?.description,
    };
  } catch {
    return {};
  }
}

const curatedRepos = [
  'https://github.com/martinruizn/sfb1.git',
  'https://github.com/martinruizn/ClasesKruger.git',
  'https://github.com/martinruizn/Portfolio.git',
  'https://github.com/martinruizn/frontend-vercel-mr.git',
];

const curated = await Promise.all(
  curatedRepos.map(async (href) => {
    const meta = await getRepoMeta(href);
    const url = new URL(href);
    const segments = url.pathname.split('/').filter(Boolean);
    const repoName = (segments[1] || '').replace(/\.git$/, '');
    return {
      title: meta.name ?? repoName,
      teaser: meta.description ?? 'Repositorio en GitHub',
      year: undefined,
      tags: ['github'],
      href,
      avatar: meta.avatar,
      stars: meta.stars,
    };
  }),
);

const padded = [
  ...curated,
  ...Array(Math.max(0, 4 - curated.length))
    .fill(null)
    .map(() => ({
      title: 'Proyecto en GitHub',
      teaser: 'Visita mis repositorios para ver más trabajos.',
      year: undefined,
      tags: ['github'],
      href: 'https://github.com/martinruizn?tab=repositories',
      avatar: undefined,
      stars: undefined,
    })),
].slice(0, 4);
---

<BaseLayout
  title="Martin Ruiz — Portafolio"
  description="Portafolio de Martin Ruiz"
>
  <section class="py-16">
    <div class="text-center">
      <div
        class="mx-auto mb-6 h-28 w-28 overflow-hidden rounded-full ring-2 ring-brand ring-offset-2 ring-offset-white dark:ring-offset-neutral-950 shadow-[0_16px_24px_-8px_rgba(0,0,0,0.45)]"
      >
        <img
          src="/avatar.jpg"
          alt="Foto de Martin Ruiz"
          width="112"
          height="112"
          class="h-full w-full object-cover"
          onerror="this.onerror=null;this.src='/avatar.svg'"
          loading="eager"
        />
      </div>
      <h1 class="text-4xl font-extrabold tracking-tight sm:text-5xl">
        Martin Ruiz
      </h1>
      <p
        id="hero-role"
        class="mt-4 text-lg text-neutral-600 dark:text-neutral-300"
      >
        Desarrollador Fullstack
      </p>
      <div class="mt-8 flex items-center justify-center gap-3">
        <a
          id="cta-github"
          href="https://github.com/martinruizn?tab=repositories"
          class="btn !text-white dark:!text-neutral-300">Ver en GitHub</a
        >
        <a
          id="cta-blog"
          href="/blog"
          class="btn-outline !text-neutral-900 dark:!text-neutral-300">Blog</a
        >
      </div>
    </div>
  </section>
  <section class="mt-6">
    <div class="card p-8">
      <div class="prose">
        <h2>Sobre mí</h2>
        <p>
          Hola, soy Martín. Pasé casi 10 años en el mundo comercial hasta que
          descubrí que lo mío también estaba en el código. Hoy me dedico al
          desarrollo de software, donde mezclo mi experiencia en los negocios
          con la creatividad de programar e implementar IA. Me gusta trabajar
          con tecnologías web como JavaScript, React, Node.js, pero sobre todo,
          me apasiona aprender, construir y compartir proyectos que realmente
          aporten algo a las personas.
        </p>
      </div>
    </div>
  </section>
  <section class="mt-16">

    <h2 id="home-recent" class="mb-6 text-xl font-bold">Proyectos recientes</h2>
    <div class="grid gap-4 sm:grid-cols-2">
      {
        padded.map((p) => (
          <ProjectCard
            title={p.title}
            teaser={p.teaser}
            year={p.year}
            tags={p.tags}
            href={p.href}
            avatar={p.avatar}
            stars={p.stars}
          />
        ))
      }
    </div>
  </section>
  <section class="mt-16">
    <div class="card p-8">
      <div
        class="flex flex-col items-start justify-between gap-6 sm:flex-row sm:items-center"
      >
        <div>
          <h2 id="home-talk-title" class="text-xl font-bold">¿Hablamos?</h2>
          <p
            id="home-talk-body"
            class="mt-1 text-neutral-600 dark:text-neutral-300"
          >
            ¿Tienes una idea, proyecto o propuesta? Hagámoslo realidad.
          </p>
        </div>
        <div class="flex gap-3">
          <a
            id="cta-write"
            class="btn !text-white dark:!text-neutral-300"
            href="mailto:hola@martin.dev">Escríbeme</a
          >
          <a
            id="cta-linkedin"
            class="btn-outline !text-neutral-900 dark:!text-neutral-300"
            href="https://www.linkedin.com/in/martin-ruizn/"
            >Conectemos en LinkedIn</a
          >
        </div>
      </div>
    </div>
  </section>
</BaseLayout>

<script type="module">
  import { getT, onLangChange } from '/src/i18n/index.ts';
  const t = (key) => {
    try {
      return getT(document.documentElement.lang)(key);
    } catch {
      return key;
    }
  };
  function updateHomeTexts() {
    const role = document.getElementById('hero-role');
    if (role) role.textContent = t('hero.role');
    const recent = document.getElementById('home-recent');
    if (recent) recent.textContent = t('home.recentProjects');
    const talkTitle = document.getElementById('home-talk-title');
    if (talkTitle) talkTitle.textContent = t('home.talkTitle');
    const talkBody = document.getElementById('home-talk-body');
    if (talkBody) talkBody.textContent = t('home.talkBody');
    const gh = document.getElementById('cta-github');
    if (gh) gh.textContent = t('cta.viewGithub');
    const blog = document.getElementById('cta-blog');
    if (blog) blog.textContent = t('cta.blog');
    const write = document.getElementById('cta-write');
    if (write) write.textContent = t('cta.writeMe');
    const li = document.getElementById('cta-linkedin');
    if (li) li.textContent = t('cta.connectLinkedIn');
  }
  updateHomeTexts();
  onLangChange(() => updateHomeTexts());
</script>
